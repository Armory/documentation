#!/bin/bash
set -e
cd "$(dirname "$0")"/..
chmod -R 777 "$(pwd)"
rm -dfr _site

SEMVER_REGEX='^[0-9]+\.[0-9]+\.[0-9]+$'

PAGE_NUM=1
halyard_armory_version=
while [ -z ${halyard_armory_version} ]; do
    echo "Getting tags for halyard-armory, page: ${PAGE_NUM}"
    TAGS=$(wget -O - -q https://registry.hub.docker.com/v2/repositories/armory/halyard-armory/tags?page=${PAGE_NUM} | docker run -i --rm realguess/jq:1.4 jq --raw-output '."results" | .[] .name | select(. != "latest")')
    for TAG in $TAGS; do
        if [[ "${TAG}" =~ ${SEMVER_REGEX} ]]; then
            halyard_armory_version="${TAG}"
            break
        fi
    done

    PAGE_NUM=$((${PAGE_NUM} + 1))


    # let's not go too crazy
    if [ $PAGE_NUM -gt 10 ]; then
      break
    fi
done

sed "s|halyard-armory-version:.*|halyard-armory-version: $halyard_armory_version|" _data/versions.yml > _data/versions.yml.new
mv _data/versions.yml.new _data/versions.yml

docker build -t armory/documentation .

docker run --rm --user="root" -v "$(pwd):/srv/jekyll" armory/documentation bash -c "jekyll build"
